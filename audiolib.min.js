(function(f){function g(j){var m,k=j.length,h={};for(m=0;m<k;m++){h[j[m]]=true}return h}var e=g([256,512,1024,2048,4096,8192,16384]),b=g([44100,22050]);function d(p,l,n,i){p=b[p]?p:44100;i=e[i]?bufferSize:p/2;var k=0,o=null,m=new Audio(),h;function j(){var q,t,s,r;if(o){q=m.mozWriteAudio(o);k+=q;if(q<o.length){o=o.slice(q);return o}o=null}t=m.mozCurrentSampleOffset();s=Number(t+i*l-k)+0;if(s>0){r=new Float32Array(s);n(r);q=m.mozWriteAudio(r);if(q<r.length){o=r.slice(q)}k+=q}}m.mozSetup(l,p);h=setInterval(j,20);this.kill=function(){clearInterval(h)};this.sampleRate=p}function a(j,l,n,i){j=b[j]?j:44100;i=e[i]?bufferSize:8192;var k=new (f.AudioContext||f.webkitAudioContext)(j),m=k.createJavaScriptNode(4096,0,l);function h(v){var o=v.outputBuffer,r=o.numberOfChannels,t,q,s=o.length,w=o.size,u=new Array(r),p=new Float32Array(s*r);for(t=0;t<r;t++){u[t]=o.getChannelData(t)}n(p);for(t=0;t<s;t++){for(q=0;q<r;q++){u[q][t]=p[t*r+q]}}}m.onaudioprocess=h;m.connect(k.destination);this.kill=function(){};this.sampleRate=k.sampleRate}function c(i,j,l,h){try{return new d(i,j,l,h)}catch(m){}try{return new a(i,j,l,h)}catch(k){}throw"No audio device available."}f.AudioDevice=c}(this));function Delay(k,g,e){var m=this,f=(!k?44100:k)*2,j=new Float32Array(f),i=0,h=0,d=0;function l(){h=f/m.samplerate/m.time*1000;d=m.time}function b(o,q,p){var n=q;while(n++!==p){if(n>=f){n=0}j[n]=o}}function c(n){j[i++]+=n;if(i>m.time/1000*m.samplerate){i=0}j[i]=j[i]*m.feedback}function a(o){var n=Math.floor(i);if(d!==m.time){l()}i+=h;if(i>=f){i-=f}b(o+j[Math.floor(i)]*m.feedback,n,Math.floor(i))}this.time=!g?1000:g;this.feedback=0;this.algorithm=0;this.samplerate=k;this.pushSample=function(n){if(this.algorithm===0){return c(n)}return a(n)};this.getMix=function(){return j[Math.floor(i)]}}function Distortion(b){var e=new IIRFilter(b,720.484),d=new IIRFilter(b,723.431),c=new IIRFilter(b,1),a=0;this.gain=4;this.master=1;this.samplerate=b;this.pushSample=function(f){e.pushSample(f);a=e.getMix(1)*this.gain;a=Math.atan(a)+a;if(a>0.4){a=0.4}else{if(a<-0.4){a=-0.4}}d.pushSample(a);c.pushSample(d.getMix(0));a=c.getMix(1)*this.master.value};this.getMix=function(){return a}}function IIRFilter(g,b,m){this.cutoff=!b?20000:b;this.resonance=!m?0.1:m;this.samplerate=g;var n=this,i=[0,0,0,0],a,d,l,c,k=Math.sin,e=Math.min,h=Math.pow;function j(){a=2*k(Math.PI*e(0.25,n.cutoff/(n.samplerate*2)));d=e(2*(1-h(n.resonance,0.25)),e(2,2/a-a*0.5))}this.pushSample=function(f){if(l!==this.cutoff||c!==this.resonance){j();l=this.cutoff;c=this.resonance}i[3]=f-d*i[2];i[0]=i[0]+a*i[2];i[1]=i[3]-i[0];i[2]=a*i[1]+i[2];i[3]=f-d*i[2];i[0]=i[0]+a*i[2];i[1]=i[3]-i[0];i[2]=a*i[1]+i[2]};this.getMix=function(f){return i[f]}}function LowPassFilter(b,c,d){var a=[0,0];this.cutoff=!c?20000:c;this.resonance=!d?0:d;this.samplerate=b;this.pushSample=function(f){var e=this.cutoff*2/this.samplerate,g=this.resonance+this.resonance/(1-e);a[0]=a[0]+e*(f-a[0]+g*(a[0]-a[1]));a[1]=a[1]+e*(a[0]-a[1])};this.getMix=function(){return a[1]}}function LP12Filter(g,d,n){this.cutoff=!d?20000:d;this.resonance=!n?1:n;this.samplerate=g;var o=this,l=0,f=0,i=Math.PI*2,k,b,a,j,m,e;function h(){k=i*o.cutoff/o.samplerate;b=1-k/(2*(o.resonance+0.5/(1+k))+k-2);a=b*b;j=a+1-2*Math.cos(k)*b}this.pushSample=function(c){if(m!==this.cutoff||e!==this.resonance){h();m=this.cutoff;e=this.resonance}l+=(c-f)*j;f+=l;l*=a};this.getMix=function(){return f};h()}function MidiEventTracker(b){var j=this,g=[];this.velocity=0;this.legato=0;this.retrigger=0;this.polyphony=1;this.activeKeys=[];this.voices=[];this.pitchBend=0;function h(k,l){this.key=k;this.velocity=l;this.noteOff=function(){};this.onKeyChange=function(){};this.changeKey=function(n,m){this.key=n;this.v=m;this.onKeyChange()};this.getFrequency=function(){return j.getFrequencyForKey(this.key)};j.voice.apply(this)}function e(l){var k;for(k=0;k<g.length;k++){if(g[k].key===l){g.splice(k--,1)}}}function i(k,l){e(k);g.push({key:k,velocity:l})}function c(){var k,m,l=[];if(j.legato===0){l=g.slice(0)}else{if(j.legato===1){for(k=0;k<g.length;k++){for(m=0;m<l.length;m++){if(m===g.length-1||(l[m-1].key>g[k].key&&l[m].key<g[k].key)){l.splice(m,0,g[k]);break}}}}else{if(j.legato===2){for(k=0;k<g.length;k++){for(m=0;m<l.length;m++){if(m===g.length-1||(l[m-1].key<g[k].key&&l[m].key>g[k].key)){l.splice(m,0,g[k]);break}}}}}}j.activeKeys=l.slice(-j.polyphony)}function a(){if(!j.voice){return}var k,m,l;if(j.polyphony===1&&j.activeKeys.length>0){k=j.activeKeys.length-1;if(j.voices.length===0){j.voices.push(new h(j.activeKeys[k].key,j.activeKeys[k].velocity))}else{j.voices[0].changeKey(j.activeKeys[k].key,j.activeKeys[k].velocity)}}else{for(m=0;m<j.activeKeys.length;m++){l=false;for(k=0;k<j.voices.length;k++){if(j.voices[k].key===j.activeKeys[m].key){l=true;break}}if(!l){j.voices.push(new h(j.activeKeys[k].key,j.activeKeys[k].velocity))}}}for(k=0;k<j.voices.length;k++){l=false;for(m=0;m<j.activeKeys.length;m++){if(j.voices[k].key===j.activeKeys[m].key){l=true;break}}if(!l){j.voices[k].noteOff();j.voices.splice(k--,1)}}}function f(l,m){var k=j.activeKeys.length;i(l,m);c();a();j.onNoteOn(l,m);if(j.retrigger===0||(k===0&&j.activeKeys.length>0)){j.onTrigger()}}function d(k,l){e(k,l);c();a();j.onNoteOff(k,l);if(j.activeKeys===0){j.onRelease()}}this.onMidi=function(k){switch(k.status){case 9:f(k.data1,k.data2/127);break;case 8:d(k.data1,k.data2/127);break;case 14:j.pitchBend=(k.data1*128+k.data2-8192)/8192;break}};this.getFrequencyForKey=function(k){return 440*Math.pow(1.059,k-69)};this.getFrequency=function(){var l=[],k;for(k=0;k<j.activeKeys.length;k++){l.push(j.getFrequencyForKey(j.activeKeys[k].key))}if(l.length>2){return l[0]}return l};this.onTrigger=function(){};this.onRelease=function(){};this.onNoteOn=function(){};this.onNoteOff=function(){};this.voice=null;this.listener=function(k){j.onMidi(k)}}function Oscillator(d,f){var b=0,e=0,c=Math.PI*2,a=new Float32Array(1);this.frequency=440;if(f){this.frequency=f}this.phaseOffset=0;this.pulseWidth=0.5;this.waveShape=0;this.samplerate=d;this.generate=function(){var k=this.frequency+0,j=this.pulseWidth,h,g=arguments.length;for(h=0;h<g;h++){k+=k*arguments[h]}b+=k/this.samplerate/2;b=b%1;e=(b+this.phaseOffset)%1;if(e<j){e=e/j}else{e=(e-j)/(1-j)}};this.getMix=function(){switch(this.waveShape){case 1:return this.triangle();break;case 2:return this.pulse();break;case 3:return this.sawtooth();break;case 4:return this.invSawtooth();break;case 5:return this.square();break;default:return this.sine()}};this.getPhase=function(){return e};this.reset=function(){b=0};this.setWavetable=function(g){if(!g instanceof Float32Array){return false}a=g.slice(0);return true};this.sine=function(){return Math.sin(e*c)};this.triangle=function(){if(e<0.5){return 4*e-1}return 3-4*e};this.square=function(){return(e<0.5)?-1:1};this.sawtooth=function(){return 1-e*2};this.invSawtooth=function(){return e*2-1};this.pulse=function(){if(e<0.5){if(e<0.25){return e*8-1}else{return 1-(e-0.25)*8}}return -1};this.wavetable=function(){return a[Math.floor(e*a.length)]}};